/*
 * checkout.js - Shopp catalog behaviors library
 * Copyright ?? 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var c=jqnc(),l=false,d=c(".sameaddress"),b=c("#submit-login-checkout"),m=c("#account-login-checkout"),h=c("#password-login-checkout"),k=c("#guest-checkout"),j=c("#checkout.shopp"),r=c("#shipping-address-fields"),n=c("#billing-address-fields"),q=c("#checkout.shopp [name=paymethod]"),a=c("#billing-locale"),s=c("#billing-card"),o=c("#billing-cardtype"),u=c(".payoption-button"),p=c("#shopp-checkout-function"),g=c("#checkout.shopp li.locale");if(j.find("input[name=checkout]").val()=="process"){if(q.length==0){f(false,d_pm)}else{q.change(f).change()}}j.bind("shopp_validate",function(){if(!e()){this.shopp_validation=["Not a valid card number.",s.get(0)]}});s.change(e);o.change(function(){var w=new String(o.val()).toLowerCase(),v=paycards[w];c(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!v||!v.inputs){return}c.each(v.inputs,function(x,y){c("#billing-xcsc-"+x).attr("disabled",false).removeClass("disabled")})}).change();if(a.children().size()==0){g.hide()}c.fn.setDisabled=function(v){c(this).each(function(){if(v){c(this).attr("disabled",true).addClass("disabled")}else{c(this).attr("disabled",false).removeClass("disabled")}});return c(this)};b.click(function(v){j.unbind("submit.validate").bind("submit.validlogin",function(x){var w=false;if(""==h.val()){w=[$co.loginpwd,h]}if(""==m.val()){w=[$co.loginname,m]}if(w){x.preventDefault();j.unbind("submit.validlogin").bind("submit.validate",function(y){return validate(this)});alert(w[0]);w[1].focus().addClass("error");return false}p.val("login")})});c("#billing-country,#shipping-country").change(function(y,B){var x=c(this).attr("id").split("-")[0],A=c(this).val(),w=c("#"+x+"-state"),z=c("#"+x+"-state-menu"),v='<option value=""></option>';if(z.length==0){return true}if(z.hasClass("hidden")){z.removeClass("hidden").hide()}if(regions[A]||(B&&z.find("option").length>1)){w.setDisabled(true).addClass("_important").hide();if(regions[A]){c.each(regions[A],function(D,C){v+='<option value="'+D+'">'+C+"</option>"});if(!B){z.empty().append(v).setDisabled(false).show().focus()}}z.setDisabled(false).show();c("label[for="+w.attr("id")+"]").attr("for",z.attr("id"))}else{z.empty().setDisabled(true).hide();w.setDisabled(false).show().removeClass("_important");c("label[for="+z.attr("id")+"]").attr("for",w.attr("id"));if(!B){w.val("").focus()}}}).trigger("change",[true]);c("#billing-country, .billing-state, #shipping-country, .shipping-state").bind("change.localemenu",function(y,B){var A=d.is(":checked")?d.val():false,z="shipping"==A?c("#billing-country").val():c("#shipping-country").val(),x="shipping"==A?c('.billing-state[disabled!="true"]').val():c('.shipping-state[disabled!="true"]').val(),C=z+x,w,v;if(B||!a.get(0)||(!A&&(c(this).is("#billing-country")||c(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if(locales&&(v=locales[C])||(v=locales[z])){w+="<option></option>";c.each(v,function(E,D){w+='<option value="'+D+'">'+D+"</option>"});c(w).appendTo(a);a.removeAttr("disabled");g.show()}});c("#firstname,#lastname").change(function(){c("#billing-name,#shipping-name").val(new String(c("#firstname").val()+" "+c("#lastname").val()).trim())});d.change(function(z,B){var w=false,y=c("#billing-country"),A=c("#shipping-country"),v="billing"==d.val()?r:n,x="shipping"==d.val()?r:n;if(d.is(":checked")){v.removeClass("half");x.hide().find(".required").setDisabled(true)}else{v.addClass("half");x.show().find(".disabled:not(._important)").setDisabled(false);if(!B){w=true}}if(y.is(":visible")){y.trigger("change.localemenu",[B])}if(A.is(":visible")){A.trigger("change.localemenu",[B])}if(w){x.find("input:first").focus()}}).trigger("change",[true]).click(function(){c(this).change()});k.change(function(v){var w=j.find("input.passwords"),x=[];c.each(w,function(){x.push("label[for="+c(this).attr("id")+"]")});x=j.find(x.join(","));if(k.is(":checked")){w.setDisabled(true).hide();x.hide()}else{w.setDisabled(false).show();x.show()}}).trigger("change");c(".shopp .shipmethod").change(function(){if("process"==c("#checkout #shopp-checkout-function").val()){var z=".shopp-cart.cart-",y="span"+z,w="input"+z,v=["shipping","tax","total"],x=[];c.each(v,function(B,A){x.push(y+A)});if(!c_upd){c_upd="?"}c(x.join(",")).html(c_upd);c.getJSON($co.ajaxurl+"?action=shopp_ship_costs&method="+c(this).val(),function(A){c.each(v,function(C,B){c(y+B).html(asMoney(new Number(A[B])));c(w+B).val(new Number(A[B]))})})}else{c(this).parents("form").submit()}});c(window).load(function(){c(document).trigger("shopp_paymethod",[q.val()])});function f(A,y){if(!y){y=c(this).val()}var z=c(this),v=c(".payoption-"+y),x="",w=false;if(this!=window&&z.attr&&z.attr("type")=="radio"&&z.attr("checked")==false){return}c(document).trigger("shopp_paymethod",[y]);u.hide();if(v.length==0){v=c(".payoption-0")}if(pm_cards[y]&&pm_cards[y].length>0){j.find(".payment,.paycard").show();j.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){c.each(pm_cards[y],function(B,C){if(!paycards[C]){return}w=paycards[C];x+='<option value="'+w.symbol+'">'+w.name+"</option>"});o.html(x).change()}}else{j.find(".payment,.paycard").hide();j.find(".paycard").attr("disabled",true).addClass("disabled")}v.show()}function e(){if(s.length==0){return true}if(s.attr("disabled")){return true}var w=s.val().replace(/\D/g,""),y=q.filter(":checked").val()?q.filter(":checked").val():q.val(),x=false;if(!y){y=d_pm}if(s.val().match(/(X)+\d{4}/)){return true}if(!pm_cards[y]){return true}c.each(pm_cards[y],function(v,A){var z=paycards[A],B=new RegExp(z.pattern.substr(1,z.pattern.length-2));if(w.match(B)){x=z.symbol;return o.val(x).change()}});if(!t(w)){return false}return x}function t(w){w=w.toString().replace(/\D/g,"").split("").reverse();if(!w.length){return false}var v=0;for(i=0;i<w.length;i++){w[i]=parseInt(w[i],10);v+=i%2?2*w[i]-(w[i]>4?9:0):w[i]}return(v%10)==0}});if(!locales){var locales=false};