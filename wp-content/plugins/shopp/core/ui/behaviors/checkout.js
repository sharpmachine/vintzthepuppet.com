/*
 * checkout.js - Shopp catalog behaviors library
 * Copyright ?? 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var c=jqnc(),l=false,d=c(".sameaddress"),b=c("#submit-login-checkout"),m=c("#account-login-checkout"),h=c("#password-login-checkout"),k=c("#guest-checkout"),j=c("#checkout.shopp"),q=c("#shipping-address-fields"),n=c("#billing-address-fields"),p=c("#checkout.shopp [name=paymethod]"),a=c("#billing-locale"),r=c("#billing-card"),o=c("#billing-cardtype"),t=c(".payoption-button"),g=c("#checkout.shopp li.locale");if(j.find("input[name=checkout]").val()=="process"){if(p.length==0){f(false,d_pm)}else{p.change(f).change()}}j.bind("shopp_validate",function(){if(!e()){this.shopp_validation=["Not a valid card number.",r.get(0)]}});r.change(e);o.change(function(){var v=o.val(),u=paycards[v.toLowerCase()];c(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!u||!u.inputs){return}c.each(u.inputs,function(w,x){c("#billing-xcsc-"+w).attr("disabled",false).removeClass("disabled")})}).change();if(a.children().size()==0){g.hide()}c.fn.setDisabled=function(u){c(this).each(function(){if(u){c(this).attr("disabled",true).addClass("disabled")}else{c(this).attr("disabled",false).removeClass("disabled")}});return c(this)};b.click(function(){l=true});j.unbind("submit.validate").submit(function(){if(l){if(m.val()==""){alert($co.loginname);m.focus();l=false;return false}if(h.val()==""){alert($co.loginpwd);h.focus();l=false;return false}c("#process-login").val("true");return true}if(validate(this)){return true}else{return false}});c("#billing-country,#shipping-country").change(function(x,A){var w=c(this).attr("id").split("-")[0],z=c(this).val(),v=c("#"+w+"-state"),y=c("#"+w+"-state-menu"),u='<option value=""></option>';if(y.length==0){return true}if(y.hasClass("hidden")){y.removeClass("hidden").hide()}if(regions[z]||(A&&y.find("option").length>1)){v.setDisabled(true).hide();if(regions[z]){c.each(regions[z],function(C,B){u+='<option value="'+C+'">'+B+"</option>"});if(!A){y.empty().append(u).setDisabled(false).show().focus()}}y.setDisabled(false).show();c("label[for="+v.attr("id")+"]").attr("for",y.attr("id"))}else{y.empty().setDisabled(true).hide();v.setDisabled(false).show();c("label[for="+y.attr("id")+"]").attr("for",v.attr("id"));if(!A){v.val("").focus()}}}).trigger("change",[true]);c("#billing-country, .billing-state, #shipping-country, .shipping-state").bind("change.localemenu",function(x,A){var z=d.is(":checked")?d.val():false,y="shipping"==z?c("#billing-country").val():c("#shipping-country").val(),w="shipping"==z?c('.billing-state[disabled!="true"]').val():c('.shipping-state[disabled!="true"]').val(),B=y+w,v,u;if(A||!a.get(0)||(!z&&(c(this).is("#billing-country")||c(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if(locales&&(u=locales[B])||(u=locales[y])){v+="<option></option>";c.each(u,function(D,C){v+='<option value="'+C+'">'+C+"</option>"});c(v).appendTo(a);a.removeAttr("disabled");g.show()}});d.change(function(y,A){var v=false,x=c("#billing-country"),z=c("#shipping-country"),u="billing"==d.val()?q:n,w="shipping"==d.val()?q:n;if(d.is(":checked")){u.removeClass("half");w.hide().find(".required").setDisabled(true)}else{u.addClass("half");w.show().find(".disabled").setDisabled(false);if(!A){v=true}}if(x.is(":visible")){x.trigger("change.localemenu",[A])}if(z.is(":visible")){z.trigger("change.localemenu",[A])}if(v){w.find("input:first").focus()}}).trigger("change",[true]).click(function(){c(this).change()});k.change(function(u){var v=j.find("input.passwords"),w=[];c.each(v,function(){w.push("label[for="+c(this).attr("id")+"]")});w=j.find(w.join(","));if(k.is(":checked")){v.setDisabled(true).hide();w.hide()}else{v.setDisabled(false).show();w.show()}}).trigger("change");c(".shopp .shipmethod").change(function(){if("process"==c("#checkout #shopp-checkout-function").val()){var y=".shopp-cart.cart-",x="span"+y,v="input"+y,u=["shipping","tax","total"],w=[];c.each(u,function(A,z){w.push(x+z)});if(!c_upd){c_upd="?"}c(w.join(",")).html(c_upd);c.getJSON($co.ajaxurl+"?action=shopp_ship_costs&method="+c(this).val(),function(z){c.each(u,function(B,A){c(x+A).html(asMoney(new Number(z[A])));c(v+A).val(new Number(z[A]))})})}else{c(this).parents("form").submit()}});c(window).load(function(){c(document).trigger("shopp_paymethod",[p.val()])});function f(z,x){if(!x){x=c(this).val()}var y=c(this),u=c(".payoption-"+x),w="",v=false;if(this!=window&&y.attr&&y.attr("type")=="radio"&&y.attr("checked")==false){return}c(document).trigger("shopp_paymethod",[x]);t.hide();if(u.length==0){u=c(".payoption-0")}if(pm_cards[x]&&pm_cards[x].length>0){j.find(".payment,.paycard").show();j.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){c.each(pm_cards[x],function(A,B){if(!paycards[B]){return}v=paycards[B];w+='<option value="'+v.symbol+'">'+v.name+"</option>"});o.html(w).change()}}else{j.find(".payment,.paycard").hide();j.find(".paycard").attr("disabled",true).addClass("disabled")}u.show()}function e(){if(r.length==0){return true}if(r.attr("disabled")){return true}var u=r.val().replace(/\D/g,""),x=p.filter(":checked").val()?p.filter(":checked").val():p.val(),w=false;if(!x){x=d_pm}if(r.val().match(/(X)+\d{4}/)){return true}if(!pm_cards[x]){return true}c.each(pm_cards[x],function(v,z){var y=paycards[z],A=new RegExp(y.pattern.substr(1,y.pattern.length-2));if(u.match(A)){w=y.symbol;return o.val(w).change()}});if(!s(u)){return false}return w}function s(v){v=v.toString().replace(/\D/g,"").split("").reverse();if(!v.length){return false}var u=0;for(i=0;i<v.length;i++){v[i]=parseInt(v[i],10);u+=i%2?2*v[i]-(v[i]>4?9:0):v[i]}return(u%10)==0}});if(!locales){var locales=false};